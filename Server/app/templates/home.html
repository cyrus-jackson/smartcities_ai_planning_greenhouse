<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Greenhouse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body, html { height: 100%; }
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
        }
        .notification-area {
            min-height: 60px;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            height: 260px;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <span class="dashboard-title text-success">Smart Greenhouse</span>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-12">
            <div id="notificationArea" class="notification-area"></div>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card border-primary shadow-sm">
                <div class="card-header bg-primary text-white card-title d-flex justify-content-between align-items-center">
                    <span>Temperature (&deg;C)</span>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Temperature Interval">
                        <button type="button" class="btn btn-light" onclick="updateChart('temperature', '15m', this)">15min</button>
                        <button type="button" class="btn btn-light" onclick="updateChart('temperature', '30m', this)">30min</button>
                        <button type="button" class="btn btn-light active" onclick="updateChart('temperature', '1h', this)">1h</button>
                    </div>
                </div>
                <div class="card-body bg-light chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success shadow-sm">
                <div class="card-header bg-success text-white card-title d-flex justify-content-between align-items-center">
                    <span>Humidity (%)</span>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Humidity Interval">
                        <button type="button" class="btn btn-light" onclick="updateChart('humidity', '15m', this)">15min</button>
                        <button type="button" class="btn btn-light" onclick="updateChart('humidity', '30m', this)">30min</button>
                        <button type="button" class="btn btn-light active" onclick="updateChart('humidity', '1h', this)">1h</button>
                    </div>
                </div>
                <div class="card-body bg-light chart-container">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning shadow-sm">
                <div class="card-header bg-warning text-dark card-title d-flex justify-content-between align-items-center">
                    <span>Soil Moisture (%)</span>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Soil Moisture Interval">
                        <button type="button" class="btn btn-light" onclick="updateChart('soil_moisture', '15m', this)">15min</button>
                        <button type="button" class="btn btn-light" onclick="updateChart('soil_moisture', '30m', this)">30min</button>
                        <button type="button" class="btn btn-light active" onclick="updateChart('soil_moisture', '1h', this)">1h</button>
                    </div>
                </div>
                <div class="card-body bg-light chart-container">
                    <canvas id="soilMoistureChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="toastArea"></div>
</div>
<script>
    let chartRefs = {
        temperature: null,
        humidity: null,
        soil_moisture: null
    };
    let currentIntervals = {
        temperature: '1h',
        humidity: '1h',
        soil_moisture: '1h'
    };
    let lastNotificationMsg = null;

    async function fetchSensorData(interval) {
        const resp = await fetch(`/data?interval=${interval}`);
        return resp.json();
    }

    function showNotification(message, type="info") {
        const area = document.getElementById('notificationArea');
        area.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    }

    function showToast(message, type="info") {
        const toastId = "toast" + Date.now();
        const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>Notification:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>`;
        const toastArea = document.getElementById('toastArea');
        toastArea.insertAdjacentHTML('beforeend', toastHtml);
        const toastElem = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElem);
        toast.show();
        toastElem.addEventListener('hidden.bs.toast', () => toastElem.remove());
    }

    async function fetchNotifications() {
        const resp = await fetch('/notifications');
        const data = await resp.json();
        if (data.notifications && data.notifications.length > 0) {
            // Show a toast for each new notification message
            data.notifications.forEach(n => {
                if (!lastNotificationMsg || lastNotificationMsg !== n.message) {
                    showToast(n.message, n.type);
                    lastNotificationMsg = n.message;
                }
            });
        }
    }

    function buildMultiAxisChart(ctx, label, dataArr, planArr, color, planColor, yLabel) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataArr.map(d => d.time),
                datasets: [
                    {
                        label: label,
                        data: dataArr.map(d => d.value),
                        borderColor: color,
                        backgroundColor: color.replace('1)', '0.1)'),
                        tension: 0.3,
                        fill: true,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Plan ID',
                        data: planArr.map(d => d.value),
                        borderColor: planColor,
                        backgroundColor: planColor.replace('1)', '0.1)'),
                        tension: 0.3,
                        fill: false,
                        yAxisID: 'y1',
                        pointStyle: 'rectRot',
                        borderDash: [5, 5],
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: yLabel }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Plan ID' },
                        ticks: {
                            callback: function(value) {
                                return Number.isInteger(value) ? value : '';
                            }
                        }
                    }
                }
            }
        });
    }

    async function renderCharts() {
        // Render all charts with their current intervals
        await updateChart('temperature', currentIntervals.temperature);
        await updateChart('humidity', currentIntervals.humidity);
        await updateChart('soil_moisture', currentIntervals.soil_moisture);
    }

    async function updateChart(metric, interval, btn=null) {
        currentIntervals[metric] = interval;
        // Update button active state
        if (btn) {
            const btnGroup = btn.parentElement;
            Array.from(btnGroup.children).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        const data = await fetchSensorData(interval);

        let ctx, label, color, planColor, yLabel, dataArr;
        if (metric === 'temperature') {
            ctx = document.getElementById('temperatureChart').getContext('2d');
            label = 'Temperature';
            color = 'rgba(13,110,253,1)';
            planColor = 'rgba(220,53,69,1)';
            yLabel = 'Temperature (°C)';
            dataArr = data.temperature;
        } else if (metric === 'humidity') {
            ctx = document.getElementById('humidityChart').getContext('2d');
            label = 'Humidity';
            color = 'rgba(25,135,84,1)';
            planColor = 'rgba(220,53,69,1)';
            yLabel = 'Humidity (%)';
            dataArr = data.humidity;
        } else if (metric === 'soil_moisture') {
            ctx = document.getElementById('soilMoistureChart').getContext('2d');
            label = 'Soil Moisture';
            color = 'rgba(255,193,7,1)';
            planColor = 'rgba(220,53,69,1)';
            yLabel = 'Soil Moisture (%)';
            dataArr = data.soil_moisture;
        }

        // Destroy previous chart if exists
        if (chartRefs[metric]) {
            chartRefs[metric].destroy();
        }
        chartRefs[metric] = buildMultiAxisChart(
            ctx,
            label,
            dataArr,
            data.plan_id,
            color,
            planColor,
            yLabel
        );

        // Show notification if present (only for temperature to avoid duplicates)
        if (metric === 'temperature' && data.notifications && data.notifications.length > 0) {
            showNotification(data.notifications[0].message, data.notifications[0].type);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchNotifications);
    setInterval(fetchNotifications, 5000);
    document.addEventListener('DOMContentLoaded', renderCharts);

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>